proc sql;

create table work.auto_allocation_stats as

select 
	gpd.Line,
	gpd.GL_LOB,
	gpd.Coverage,
	gpd.Term,
	gpd.EP as Grouped,
	ugpd.EP as Ungrouped,
	gpd.EP / ugpd.EP as Alloc_Stat

from (

	select 
		t1.Line,
		t1.GL_LOB,
		t1.Coverage,
		t1.Term,
		sum(case when t1.Account = "Earned Premium" then t1.Amount1 else 0 end) format=20.5 as EP
	from work.MR_Final t1
	where t1.GL_LOB in ('Auto Liab', 'Auto PD') and t1.Amount1 > 0
	group by 1,2,3,4

	) gpd

full join (

	select 
		t2.GL_LOB,
		sum(case when t2.Account = "Earned Premium" then t2.Amount1 else 0 end) format=20.5 as EP
	from work.MR_Final t2
	where t2.GL_LOB in('Auto Liab', 'Auto PD') and t2.Amount1 > 0
	group by 1

	) ugpd on gpd.GL_LOB = ugpd.GL_LOB

where (CALCULATED Alloc_Stat) > 0

;quit;



proc sql;

create table work.auto as
select 
	glfn.BookDate,
	glfn.Reinsurance,
	glfn.State,
	aloc.Line,
	glfn.GL_LOB,
	glfn.Vol_Invol,
	glfn.Distribution,
	aloc.Term,
	aloc.Coverage,
	glfn.Account,
	glfn.Amount1 * aloc.Alloc_Stat as Amount
from work.GL_state_alloc glfn
inner join work.auto_allocation_stats aloc on glfn.GL_LOB = aloc.GL_LOB
where glfn.GL_LOB in ('Auto Liab', 'Auto PD') and
	glfn.Account in
		(	'APS','Acquisition','Administrative','Administrative Expense Paid',
			'Amortization - DAC Commissions','Amortization - DAC General Exp',
			'Amortization - DAC Prem Tax','Amortization of DAC','Base Commissions',
			'Billing Fees','CAT ULAE','Capitalization - DAC Commissions',
			'Capitalization - DAC General Exp','Capitalization - DAC Prem Tax',
			'Capitalization of DAC','Change ALAE IBNR Rsv CY CAT',
			'Change ALAE IBNR Rsv CY NonCAT','Change ALAE IBNR Rsv PY CAT',
			'Change ALAE IBNR Rsv PY NonCAT','Change Loss IBNR Rsv CY CAT',
			'Change Loss IBNR Rsv CY NonCAT','Change Loss IBNR Rsv PY CAT',
			'Change Loss IBNR Rsv PY NonCAT','Changes in ULAE Res','Charge-offs',
			'Chg Commissions Reserve','Chg in Admin Expense Reserve','Commissions Paid',
			'Goodwill Amortization','Misc Income','Net Investment Income','Non-CAT ULAE',
			'Non-Traditional Revenue','Other Acq. Exp. Chg Reserve','Other Acq. Exp. Paid',
			'Other Bonus','Other Revenue','Premium and Other Taxes','ULAE Paid Expenses')

;quit;
