import pandas as pd

# Step 1: Read CSV file from SharePoint or local path
url = "https://libertymutual.sharepoint.com/sites/GRMFSDataStrategy/Shared Documents/General/Final Plan/USRM Versions PL TL/PL Metrics - Active Plan - Current Working PBI.csv"
df = pd.read_csv(url)

# Step 2: Rename columns for clarity
df.rename(columns={'Segment: PL': 'Segment'}, inplace=True)

# Step 3: Convert data types
df['Value'] = pd.to_numeric(df['Value'], errors='coerce')
df['Period'] = pd.to_datetime(df['Period'], errors='coerce')

# Step 4: Rename columns for consistency
df.rename(columns={
    'LOB': 'Line',
    'Channel Hierarchy': 'Channel',
    'State': 'States',
    'Value': 'Amount',
    'Period': 'Book Date'
}, inplace=True)

# Step 5: Trim leading/trailing spaces in 'Line Item' column
df['Line Item'] = df['Line Item'].str.strip()

# Step 6: Add 'State' column derived from 'States'
df['State'] = df['States'].apply(lambda x: 'State NA' if x in ['State NA', ''] else str(x)[:2])

# Step 7: Add 'Distribution' column with conditions
def get_distribution(row):
    if row['Brand Hierarchy'] == "LM" and row['Channel'] == "Platform":
        return "LM Platform"
    elif row['Segment'] == "PL Segment" and row['Channel'] == "No_Channel":
        return f"{row['Segment']}-{row['Brand Hierarchy']}{row['Channel']}"
    elif row['Segment'] == "" and row['Channel'] == "No_Channel":
        return f"PL Segment-{row['Brand Hierarchy']}{row['Channel']}"
    elif row['Segment'] == "":
        return row['Channel']
    else:
        return f"{row['Segment']}-{row['Channel']}"

df['Distribution'] = df.apply(get_distribution, axis=1)

# Step 8: Add 'Account' column with conditions
df['Account'] = df.apply(
    lambda row: "" if row['Line Item'] == "" and row['DAC Accounts'] == "" 
    else (row['Line Item'] + " - " + row['DAC 
