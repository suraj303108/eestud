import pandas as pd

# Step 1: Read CSV file from SharePoint or local path
url = "https://libertymutual.sharepoint.com/sites/GRMFSDataStrategy/Shared Documents/General/Final Plan/USRM Versions SC OP/SC Op Metrics Export - Current What If PBI.csv"
df = pd.read_csv(url)

# Step 2: Rename columns for clarity
df.rename(columns={
    'Line Item': 'Account',
    'SS: Segment: BL': 'Segment',
    'SS_LOB: BL Topline': 'Line',
    'SS_Channel: BL': 'Channel',
    'SS_States: US States Reporting': 'States',
    'Value': 'Amount',
    'Period': 'Book Date'
}, inplace=True)

# Step 3: Add 'State' column derived from 'States'
df['State'] = df['States'].apply(lambda x: 'State NA' if x == '' else str(x)[:2])

# Step 4: Add 'Distribution' column by combining 'Segment' and 'Channel'
df['Distribution'] = df['Segment'] + '-' + df['Channel']

# Step 5: Add 'Reinsurance' column with constant value 'RI_NA'
df['Reinsurance'] = 'RI_NA'

# Step 6: Add 'Brand' column with conditional logic
df['Brand'] = df['Channel'].apply(lambda x: 'SA' if x == 'IA (Vol) State Auto' else 'LM')

# Step 7: Remove the 'States' column
df.drop(columns=['States'], inplace=True)

# Step 8: Convert data types for consistency
df['State'] = df['State'].astype(str)
df['Distribution'] = df['Distribution'].astype(str)
df['Reinsurance'] = df['Reinsurance'].astype(str)
df['Brand'] = df['Brand'].astype(str)
df['Book Date'] = pd.to_datetime(df['Book Date'], errors='coerce')
df['Amount'] = pd.to_numeric(df['Amount'], errors='coerce')

# Step 9: Rename specific values in 'Account' column
df['Account'] = df['Account'].replace({
    'NB Summary Num: Final Rate': 'NB Rate Numerator',
    'RB Summary Num: Final Rate': 'RB Rate Numerator',
    'NB Summary Denom: Final Rate': 'NB Rate Denominator',
    'RB Summary Denom: Final Rate': 'RB Rate Denominator'
})

# Step 10: Filter rows where 'Book Date' is after 2024-12-31
df = df[df['Book Date'] > pd.Timestamp('2024-12-31')]

# Final DataFrame
print(df.head())  # Or save to a new file, e.g., df.to_csv('output.csv')
