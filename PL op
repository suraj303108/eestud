/*proc import datafile  =  '/usr/apps/sasdata/financial_centrify/Fin_HO_Sec/Local_Access/Fin/Reports/DataStrategy/Topline/AllocationStats - Backup.xlsx'
 out  =  Alloc_Stats
 dbms  =  xlsx
 replace
;run;*/

PROC SQL;
   CREATE TABLE WORK.Entries_to_alloc AS 
   SELECT *
      FROM WORK.PCP_FINAL t1
      WHERE t1.Account in ('Administrative Expense Paid','Amortization of DAC','Capitalization of DAC',
           'Changes in ULAE Res','Chg Commissions Reserve','Chg in Admin Expense Reserve','Commissions Paid',
           'Other Acq. Exp. Chg Reserve','Other Acq. Exp. Paid','ULAE Paid Expenses','Billing Fees','Net Investment Income','Non-Traditional Revenue')
			AND ( t1.State IS MISSING OR t1.State = 'State N/A' ) and t1.Reinsurance not in ('G1','G2','G3','G4');
QUIT;

PROC SQL;
   CREATE TABLE WORK.Allocated_Entries_NEW AS 
   SELECT t1.BookDate, 
          t1.Reinsurance, 
          t1.State, 
          t1.Product, 
          t1.Line, 
          t1.GL_LOB, 
          t1.PRE_ALLOC_LOB, 
          t1.Vol_Invol, 
          t1.Distribution,
		  t1.Brand, 
          t1.Account, 
          t1.Amount1, 
          t2.State AS State1, 
          t2.Line AS Line1,
		  t2.Distribution as AllocBrand,
          t2.final_alloc, 
          t1.Amount1 * t2.final_alloc AS Alloc_Amount
      FROM WORK.ENTRIES_TO_ALLOC t1
	  		left join REF.gl_to_mr_line t3 on t1.Line = t3.Line
           LEFT JOIN work.alloc_stats_combined t2 ON (t1.Brand = t2.Distribution and t2.Line = t3.MR_LOB);
QUIT;
