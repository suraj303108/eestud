import pandas as pd

# Step 1: Read CSV file from the SharePoint or local path
url = "https://libertymutual.sharepoint.com/sites/GRMFSDataStrategy/Shared Documents/General/Final Plan/USRM Versions PL OP/PL Ops Metrics Export - Current What If PBI.csv"
df = pd.read_csv(url)

# Step 2: Replace 'State N/A' with 'State NA' in 'SS_States: US States' column
df['SS_States: US States'] = df['SS_States: US States'].replace('State N/A', 'State NA')

# Step 3: Add 'State' column with conditions
df['State'] = df['SS_States: US States'].apply(lambda x: 'State NA' if x in ['State NA', ''] else str(x)[:2])

# Step 4: Add 'Distribution' column with conditions based on 'Brand' and 'Channel'
df['Distribution'] = df.apply(
    lambda row: 'LM Platform' if row['Brand'] == 'LM' and row['Channel'] == 'Platform' 
    else row['Channel'], axis=1
)

# Step 5: Add 'Reinsurance' column with constant value 'Direct'
df['Reinsurance'] = 'Direct'

# Step 6: Add 'Segment' column with constant value 'PL Segment'
df['Segment'] = 'PL Segment'

# Step 7: Rename columns as required
df = df.rename(columns={'SS_LOB: Export Metric': 'Line', 'Line Item': 'Account'})

# Step 8: Drop 'SS_States: US States' column
df = df.drop(columns=['SS_States: US States'])

# Step 9: Change data types as necessary
df['State'] = df['State'].astype(str)
df['Value'] = pd.to_numeric(df['Value'], errors='coerce')
df['Period'] = pd.to_datetime(df['Period'], errors='coerce')

# Step 10: Filter rows where 'Period' is after 2024-12-31
df = df[df['Period'] > pd.Timestamp('2024-12-31')]

# Step 11: Filter out "Flood" and "Other" lines based on Account condition
df = df[~((df['Line'].isin(['Flood', 'Other'])) & 
          ~df['Account'].isin(['NB Written Premium', 'RB Written Premium']))]

# Step 12: Rename final columns
df = df.rename(columns={'Value': 'Amount', 'Period': 'Book Date'})

# Final DataFrame
print(df.head())  # Or save to a new file
