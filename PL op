let
  Source = SharePoint.Files("https://libertymutual.sharepoint.com/sites/GRMFSDataStrategy", [ApiVersion = 15]),
  #"Filtered rows" = Table.SelectRows(Source, each Text.EndsWith([Folder Path], "USRM Versions PL TL/")),
  #"Filtered hidden files" = Table.SelectRows(#"Filtered rows", each [Attributes]?[Hidden]? <> true),
  #"Invoke custom function" = Table.AddColumn(#"Filtered hidden files", "Transform file (6)", each #"Transform file (6)"([Content])),
  #"Renamed columns" = Table.RenameColumns(#"Invoke custom function", {{"Name", "Source.Name"}}),
  #"Removed other columns" = Table.SelectColumns(#"Renamed columns", {"Source.Name", "Transform file (6)"}),
  #"Expanded table column" = Table.ExpandTableColumn(#"Removed other columns", "Transform file (6)", Table.ColumnNames(#"Transform file (6)"(#"Sample file (6)"))),
  #"Changed column type" = Table.TransformColumnTypes(#"Expanded table column", {{"Source.Name", type text}, {"Line Item", type text}, {"Brand Hierarchy", type text}, {"Channel Hierarchy", type text}, {"State", type text}, {"LOB", type text}, {"Period", type date}, {"Value", type number}, {"DAC Accounts", type text}, {"RI Code", type text}, {"Segment: PL", type text}}),
  #"Added Version" = Table.AddColumn(#"Changed column type", "Version", each Text.Middle([Source.Name], 40, 4), type text),
  #"Removed Columns2" = Table.RemoveColumns(#"Added Version", {"Source.Name"}),
  #"Renamed Columns" = Table.RenameColumns(#"Removed Columns2", {{"LOB", "Line"}, {"Channel Hierarchy", "Channel"}, {"State", "States"}, {"Value", "Amount"}, {"Segment: PL", "Segment"}, {"Period", "Book Date"}}),
    #"Trimmed Line Item" = Table.TransformColumns(#"Renamed Columns", {{"Line Item", each Text.Trim(_), type nullable text}}),
  #"Replaced value 2" = Table.ReplaceValue(#"Trimmed Line Item", "DAC Amortization - Accounts", "DAC Amortization", Replacer.ReplaceText, {"Line Item"}),
  #"Replaced value 3" = Table.ReplaceValue(#"Replaced value 2", "DAC Capitalization - Accounts", "DAC Capitalization", Replacer.ReplaceText, {"Line Item"}),
    #"Added State" = Table.AddColumn(#"Replaced value 3", "State", each if [#"States"] = "State NA" then "State NA" else if [#"States"] = "" then "State NA" else Text.Start([#"States"],2)),
    #"Added Distribution" = Table.AddColumn(#"Added State", "Distribution", 
    each if [Brand Hierarchy] = "LM" and [Channel] = "Platform" then 
        "LM Platform" 
    else if [Segment] = "PL Segment" and [Channel] = "No_Channel" then 
        [Segment] & "-" & [Brand Hierarchy] & [Channel] 
    else if [Segment] = "" and [Channel] = "No_Channel" then 
        "PL Segment-" & [Brand Hierarchy] & [Channel] 
    else if [Segment] = "" then 
        [Channel] 
    else 
        [Segment] & "-" & [Channel]
),
    #"Added Account" = Table.AddColumn(#"Added Distribution", "Account", each if [Line Item] = "" and [DAC Accounts] = "" then "" else if [DAC Accounts] <> "" then [Line Item] & " - " & [DAC Accounts] else [Line Item]),
    #"Added Reinsurance" = Table.AddColumn(#"Added Account", "Reinsurance", each if  ([RI Code] = "" and ([Account] = "DAC Amortization" or [Account] = "DAC Capitalization")) then "GP" else if [RI Code] = "RI Direct" then "Direct" else if [Account] = "RI-Non CUNA Earned Premium - Assumed" then "Assumed" else if [Account] = "RI-Non CUNA Earned Premium - Ceded" then "Ceded" else if [RI Code] <> "" then [RI Code] else "Direct"),
    #"Removed Columns3" = Table.RemoveColumns(#"Added Reinsurance",{"Brand Hierarchy", "Line Item", "RI Code", "DAC Accounts", "States"}),
    #"Changed Type1" = Table.TransformColumnTypes(#"Removed Columns3", {{"State", type text}, {"Distribution", type text}, {"Reinsurance", type text}, {"Account", type text}}),
    #"Replaced Value" = Table.ReplaceValue(#"Changed Type1","","PL Segment",Replacer.ReplaceValue,{"Segment"}),
  #"Replaced value 1" = Table.ReplaceValue(#"Replaced Value", "IA (Vol) State Auto", "PL Segment-IA (Vol) State Auto", Replacer.ReplaceValue, {"Distribution"})
  in
    #"Replaced value 1"
